<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brookhaven Mathe Abenteuer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header mit Stats */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-label {
            font-size: 0.8em;
            color: #aaa;
        }

        /* Hauptbereich */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Willkommens-Screen */
        .welcome-screen {
            text-align: center;
            animation: fadeIn 1s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .game-title {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #aaa;
            margin-bottom: 30px;
        }

        .character {
            font-size: 80px;
            margin: 20px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #ffd700;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .btn {
            background: linear-gradient(45deg, #00d2d3, #54a0ff);
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,210,211,0.4);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            margin: 10px;
            padding: 10px 25px;
            font-size: 1em;
        }

        .btn-danger {
            background: linear-gradient(45deg, #e17055, #d63031);
        }

        /* Spiel-Screen */
        .game-screen {
            text-align: center;
            width: 100%;
        }

        .night-badge {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            padding: 10px 30px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .story-box {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            line-height: 1.6;
            transition: all 0.5s ease;
        }

        .character-speaking {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            text-align: left;
        }

        .character-avatar {
            font-size: 50px;
            flex-shrink: 0;
        }

        .speech-bubble {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 15px;
            position: relative;
        }

        .math-problem {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
            font-size: 2em;
            font-weight: bold;
            border: 3px solid #ffd700;
            transition: all 0.5s ease;
        }

        .answer-input {
            width: 120px;
            padding: 15px;
            font-size: 1.5em;
            text-align: center;
            border: 3px solid #ffd700;
            border-radius: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
            margin: 20px 0;
        }

        .answer-input:focus {
            outline: none;
            box-shadow: 0 0 15px rgba(255,215,0,0.5);
        }

        /* Feedback */
        .feedback {
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.2em;
            animation: popIn 0.5s ease;
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .feedback.correct {
            background: linear-gradient(45deg, #00b894, #00cec9);
        }

        .feedback.wrong {
            background: linear-gradient(45deg, #e17055, #fdcb6e);
        }

        .reward {
            font-size: 1.5em;
            margin-top: 10px;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, #ffd700, #ff6b6b);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 5px;
        }

        /* Belohnungs-Screen */
        .reward-screen {
            text-align: center;
        }

        .big-reward {
            font-size: 100px;
            animation: spin 1s ease;
        }

        @keyframes spin {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        /* Hilfe-Button */
        .help-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #e17055;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5em;
            color: white;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .hint-box {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            text-align: left;
        }

        .hidden {
            display: none !important;
        }

        /* Pet Auswahl */
        .pet-selection {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .pet-option {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .pet-option:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        .pet-option.selected {
            border-color: #ffd700;
            background: rgba(255,215,0,0.2);
        }

        .pet-option .emoji {
            font-size: 40px;
        }

        .pet-option .name {
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Streak Anzeige */
        .streak {
            color: #ff6b6b;
            font-size: 0.9em;
        }

        .streak.active {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Konfetti Canvas */
        #confettiCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        /* Neue Belohnungs-Animationen */
        @keyframes coinBurst {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-80px) scale(1.3); opacity: 1; }
            100% { transform: translateY(-150px) scale(0.5); opacity: 0; }
        }

        @keyframes starShine {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
            25% { transform: scale(1.3) rotate(10deg); opacity: 0.8; }
            50% { transform: scale(1.5) rotate(-5deg); opacity: 1; }
            75% { transform: scale(1.2) rotate(5deg); opacity: 0.9; }
        }

        @keyframes successGlow {
            0% { box-shadow: 0 0 5px rgba(0, 255, 0, 0.5); }
            50% { box-shadow: 0 0 30px rgba(0, 255, 0, 0.8), 0 0 60px rgba(0, 255, 0, 0.4); }
            100% { box-shadow: 0 0 5px rgba(0, 255, 0, 0.5); }
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        .reward-burst {
            position: fixed;
            font-size: 2em;
            pointer-events: none;
            z-index: 1001;
            animation: floatUp 1.5s ease-out forwards;
        }

        .success-glow {
            animation: successGlow 0.8s ease-in-out;
        }

        .star-shine {
            animation: starShine 1s ease-in-out;
        }

        /* Bedrohliche Situationen */
        @keyframes dangerPulse {
            0%, 100% { background-color: rgba(139, 0, 0, 0.1); }
            50% { background-color: rgba(139, 0, 0, 0.3); }
        }

        @keyframes glowingEyes {
            0%, 100% { text-shadow: 0 0 10px red, 0 0 20px red; }
            50% { text-shadow: 0 0 20px red, 0 0 40px red, 0 0 60px darkred; }
        }

        .danger-mode {
            animation: dangerPulse 1s infinite;
        }

        .danger-mode .math-problem {
            border-color: #ff0000 !important;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }

        .danger-mode .story-box {
            border: 2px solid #ff0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
        }

        .danger-avatar {
            animation: glowingEyes 1.5s infinite;
        }

        /* High Score Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid #ffd700;
        }

        .modal-title {
            font-size: 1.8em;
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
        }

        .highscore-table {
            width: 100%;
            border-collapse: collapse;
        }

        .highscore-table th, .highscore-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .highscore-table th {
            color: #ffd700;
        }

        .medal {
            font-size: 1.5em;
        }

        /* High Score Button */
        .highscore-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #ffd700;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5em;
            color: #333;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .victory-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .placement-badge {
            background: linear-gradient(45deg, #ffd700, #ff6b6b);
            padding: 15px 25px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.2em;
            text-align: center;
        }
    </style>
</head>
<body>
    <canvas id="confettiCanvas"></canvas>

    <div class="container">
        <!-- Header mit Stats (versteckt am Anfang) -->
        <div class="header hidden" id="header">
            <div class="stat">
                <div class="stat-value" id="coins">0</div>
                <div class="stat-label">Bloxy Coins</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="night">1</div>
                <div class="stat-label">Nacht</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="streak">0</div>
                <div class="stat-label">Serie</div>
            </div>
        </div>

        <div class="main-content">
            <!-- Willkommens-Screen -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="character">üè†</div>
                <h1 class="game-title">Brookhaven</h1>
                <h2 class="game-title">Mathe Abenteuer</h2>
                <p class="subtitle">√úberlebe 99 N√§chte und verdiene dein Traum-Pet!</p>

                <div class="input-group">
                    <label>Wie hei√üt du?</label>
                    <input type="text" id="playerName" placeholder="Dein Name...">
                </div>

                <button class="btn" onclick="showPetSelection()">Los geht's!</button>
            </div>

            <!-- Pet Auswahl Screen -->
            <div class="welcome-screen hidden" id="petScreen">
                <h2>W√§hle dein Ziel-Pet!</h2>
                <p class="subtitle">Welches Pet m√∂chtest du freischalten?</p>

                <div class="pet-selection" id="petSelection">
                    <div class="pet-option" data-pet="unicorn" data-name="Einhorn">
                        <div class="emoji">ü¶Ñ</div>
                        <div class="name">Einhorn</div>
                    </div>
                    <div class="pet-option" data-pet="dragon" data-name="Drache">
                        <div class="emoji">üêâ</div>
                        <div class="name">Drache</div>
                    </div>
                    <div class="pet-option" data-pet="cat" data-name="Katze">
                        <div class="emoji">üê±</div>
                        <div class="name">Katze</div>
                    </div>
                    <div class="pet-option" data-pet="dog" data-name="Hund">
                        <div class="emoji">üêï</div>
                        <div class="name">Hund</div>
                    </div>
                    <div class="pet-option" data-pet="phoenix" data-name="Ph√∂nix">
                        <div class="emoji">üî•</div>
                        <div class="name">Ph√∂nix</div>
                    </div>
                    <div class="pet-option" data-pet="panda" data-name="Panda">
                        <div class="emoji">üêº</div>
                        <div class="name">Panda</div>
                    </div>
                </div>

                <button class="btn" onclick="startGame()">Abenteuer starten!</button>
            </div>

            <!-- Spiel-Screen -->
            <div class="game-screen hidden" id="gameScreen">
                <div class="night-badge">üåô Nacht <span id="currentNight">1</span> von 99</div>

                <div class="progress-container">
                    <div class="progress-bar" id="progressBar" style="width: 1%"></div>
                </div>
                <div class="progress-text">Fortschritt zum <span id="targetPetName">Einhorn</span>: <span id="progressPercent">1</span>%</div>

                <div class="story-box" id="storyBox">
                    <div class="character-speaking">
                        <div class="character-avatar" id="npcAvatar">üë®‚Äçüî¨</div>
                        <div class="speech-bubble" id="storyText">
                            Willkommen in Brookhaven! Ich bin Professor Pixel. Um heute Nacht zu √ºberleben, musst du diesen Code knacken!
                        </div>
                    </div>
                </div>

                <div class="math-problem" id="mathProblem">
                    5 + 3 = ?
                </div>

                <div class="hint-box hidden" id="hintBox">
                    <strong>üí° Tipp:</strong> <span id="hintText"></span>
                </div>

                <input type="number" class="answer-input" id="answerInput" placeholder="?" onkeypress="checkEnter(event)">

                <div>
                    <button class="btn" onclick="checkAnswer()">Pr√ºfen!</button>
                </div>

                <div class="feedback hidden" id="feedback">
                    <div id="feedbackText"></div>
                    <div class="reward" id="rewardText"></div>
                </div>
            </div>

            <!-- Erfolgs-Screen -->
            <div class="reward-screen hidden" id="rewardScreen">
                <div class="big-reward" id="bigRewardEmoji">ü¶Ñ</div>
                <h1 class="game-title">Geschafft!</h1>
                <div class="placement-badge hidden" id="placementBadge"></div>
                <p id="rewardMessage">Du hast dein Einhorn verdient!</p>
                <div class="victory-buttons">
                    <button class="btn" onclick="resetGame()">Nochmal spielen</button>
                    <button class="btn btn-secondary" onclick="exportToPDF()">üìÑ PDF Export</button>
                    <button class="btn btn-secondary" onclick="showHighScores()">üèÜ High Scores</button>
                </div>
            </div>
        </div>
    </div>

    <button class="help-btn hidden" id="helpBtn" onclick="showHint()">üí°</button>
    <button class="highscore-btn hidden" id="highscoreBtn" onclick="showHighScores()">üèÜ</button>

    <!-- High Score Modal -->
    <div class="modal hidden" id="highscoreModal" onclick="closeModalOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="modal-title">üèÜ High Scores</h2>
            <table class="highscore-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Score</th>
                        <th>Nacht</th>
                    </tr>
                </thead>
                <tbody id="highscoreTableBody">
                </tbody>
            </table>
            <button class="btn" onclick="closeHighScores()">Schlie√üen</button>
        </div>
    </div>

    <script>
        // ==================== AUDIO SYSTEM ====================
        const AudioSystem = {
            context: null,

            init() {
                this.context = new (window.AudioContext || window.webkitAudioContext)();
            },

            ensureContext() {
                if (!this.context) this.init();
                if (this.context.state === 'suspended') {
                    this.context.resume();
                }
            },

            playTone(frequency, duration, type = 'sine', volume = 0.3) {
                this.ensureContext();
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);

                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, this.context.currentTime);

                gainNode.gain.setValueAtTime(volume, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + duration);

                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + duration);
            },

            playCorrectSound() {
                this.ensureContext();
                // Fr√∂hliches aufsteigendes "Ding" (C5 -> E5 -> G5)
                const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.2, 'sine', 0.3), i * 100);
                });
            },

            playWrongSound() {
                this.ensureContext();
                // Sanfter tiefer Ton
                this.playTone(220, 0.4, 'sine', 0.2);
                setTimeout(() => this.playTone(196, 0.3, 'sine', 0.15), 150);
            },

            playDangerSound() {
                this.ensureContext();
                // Bedrohlicher Ton
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);

                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(100, this.context.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(50, this.context.currentTime + 0.5);

                gainNode.gain.setValueAtTime(0.2, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.5);

                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.5);

                // Zweiter gruseliger Ton
                setTimeout(() => {
                    this.playTone(80, 0.3, 'triangle', 0.15);
                }, 300);
            },

            playVictoryFanfare() {
                this.ensureContext();
                // Sieges-Melodie
                const melody = [
                    { freq: 523.25, delay: 0 },    // C5
                    { freq: 587.33, delay: 150 },  // D5
                    { freq: 659.25, delay: 300 },  // E5
                    { freq: 783.99, delay: 450 },  // G5
                    { freq: 1046.50, delay: 700 }, // C6
                    { freq: 783.99, delay: 900 },  // G5
                    { freq: 1046.50, delay: 1100 } // C6 (final)
                ];

                melody.forEach(note => {
                    setTimeout(() => this.playTone(note.freq, 0.3, 'sine', 0.25), note.delay);
                });
            },

            playStreakSound() {
                this.ensureContext();
                // Schnelles aufsteigendes Arpeggio
                const notes = [392, 494, 587, 784]; // G4, B4, D5, G5
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.15, 'triangle', 0.2), i * 50);
                });
            }
        };

        // ==================== CONFETTI SYSTEM ====================
        const ConfettiSystem = {
            canvas: null,
            ctx: null,
            particles: [],
            animationId: null,

            init() {
                this.canvas = document.getElementById('confettiCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
            },

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },

            createParticles(count = 100) {
                this.particles = [];
                const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#00d2d3', '#54a0ff', '#ffd700', '#00b894'];

                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: -20 - Math.random() * 100,
                        size: Math.random() * 10 + 5,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        speedX: (Math.random() - 0.5) * 6,
                        speedY: Math.random() * 3 + 2,
                        rotation: Math.random() * 360,
                        rotationSpeed: (Math.random() - 0.5) * 10,
                        shape: Math.random() > 0.5 ? 'rect' : 'circle'
                    });
                }
            },

            animate() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                let activeParticles = 0;

                this.particles.forEach(p => {
                    if (p.y < this.canvas.height + 50) {
                        activeParticles++;

                        p.x += p.speedX;
                        p.y += p.speedY;
                        p.speedY += 0.1; // Gravity
                        p.rotation += p.rotationSpeed;

                        this.ctx.save();
                        this.ctx.translate(p.x, p.y);
                        this.ctx.rotate(p.rotation * Math.PI / 180);
                        this.ctx.fillStyle = p.color;

                        if (p.shape === 'rect') {
                            this.ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size / 2);
                        } else {
                            this.ctx.beginPath();
                            this.ctx.arc(0, 0, p.size / 2, 0, Math.PI * 2);
                            this.ctx.fill();
                        }

                        this.ctx.restore();
                    }
                });

                if (activeParticles > 0) {
                    this.animationId = requestAnimationFrame(() => this.animate());
                } else {
                    this.stop();
                }
            },

            launch() {
                this.stop();
                this.createParticles(100);
                this.animate();
            },

            stop() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                if (this.ctx) {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                }
            }
        };

        // ==================== REWARD ANIMATION SYSTEM ====================
        const RewardSystem = {
            showRewardBurst(emoji, x, y) {
                const element = document.createElement('div');
                element.className = 'reward-burst';
                element.textContent = emoji;
                element.style.left = x + 'px';
                element.style.top = y + 'px';
                document.body.appendChild(element);

                setTimeout(() => element.remove(), 1500);
            },

            celebrateCorrectAnswer() {
                const emojis = ['‚≠ê', 'üí∞', '‚ú®', 'üåü', 'üíé', 'üéâ'];
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;

                for (let i = 0; i < 6; i++) {
                    setTimeout(() => {
                        const emoji = emojis[Math.floor(Math.random() * emojis.length)];
                        const x = centerX + (Math.random() - 0.5) * 200;
                        const y = centerY + (Math.random() - 0.5) * 100;
                        this.showRewardBurst(emoji, x, y);
                    }, i * 100);
                }

                // Add glow to problem box
                const problemBox = document.getElementById('mathProblem');
                problemBox.classList.add('success-glow');
                setTimeout(() => problemBox.classList.remove('success-glow'), 800);
            },

            celebrateStreak(streakCount) {
                if (streakCount >= 3) {
                    const emojis = ['üî•', '‚ö°', 'üí™', 'üöÄ'];
                    for (let i = 0; i < streakCount; i++) {
                        setTimeout(() => {
                            const emoji = emojis[Math.floor(Math.random() * emojis.length)];
                            const x = Math.random() * window.innerWidth * 0.8 + window.innerWidth * 0.1;
                            const y = window.innerHeight * 0.3;
                            this.showRewardBurst(emoji, x, y);
                        }, i * 150);
                    }
                    AudioSystem.playStreakSound();
                }
            }
        };

        // ==================== HIGH SCORE SYSTEM ====================
        const HighScoreSystem = {
            maxScores: 10,

            calculateScore(gameState) {
                const nightScore = gameState.currentNight * 100;
                const coinScore = gameState.coins;
                const streakBonus = gameState.maxStreak * 50;
                const hintPenalty = gameState.hintsUsed * 10;

                return nightScore + coinScore + streakBonus - hintPenalty;
            },

            getHighScores() {
                const saved = localStorage.getItem('brookhavenHighScores');
                return saved ? JSON.parse(saved) : [];
            },

            saveHighScore(name, score, night, coins) {
                const scores = this.getHighScores();
                const newEntry = {
                    name,
                    score,
                    night,
                    coins,
                    date: new Date().toISOString()
                };

                scores.push(newEntry);
                scores.sort((a, b) => b.score - a.score);
                scores.splice(this.maxScores);

                localStorage.setItem('brookhavenHighScores', JSON.stringify(scores));

                // Return placement (1-indexed)
                return scores.findIndex(s => s.date === newEntry.date) + 1;
            },

            getPlacement(score) {
                const scores = this.getHighScores();
                let placement = scores.length + 1;
                for (let i = 0; i < scores.length; i++) {
                    if (score > scores[i].score) {
                        placement = i + 1;
                        break;
                    }
                }
                return placement <= this.maxScores ? placement : null;
            }
        };

        // ==================== DANGER SYSTEM ====================
        const DangerSystem = {
            characters: [
                { name: 'Der Kultist', emoji: 'üßô‚Äç‚ôÇÔ∏è', style: 'bedrohlich' },
                { name: 'Dunkler Kultist', emoji: 'üë§', style: 'mysteri√∂s' },
                { name: 'Der Gro√üe Elch', emoji: 'ü´é', style: 'majest√§tisch-bedrohlich' },
                { name: 'Schatten-Kultist', emoji: 'üë•', style: 'unheimlich' }
            ],

            stories: [
                "Die Schatten bewegen sich... L√∂se diese Aufgabe, bevor ES dich findet!",
                "Ich sp√ºre deine Angst... Nur die richtige Antwort kann dich noch retten.",
                "Du hast mein Reich betreten. Beweise deine W√ºrdigkeit mit Mathematik!",
                "Die Dunkelheit ruft... Nur Zahlen k√∂nnen sie aufhalten!",
                "H√∂rst du das Fl√ºstern? Rechne schnell, bevor die Stimmen lauter werden...",
                "Meine Br√ºder umzingeln dich bereits. Deine einzige Chance ist diese Aufgabe!",
                "Der Gro√üe Elch beobachtet dich aus den Schatten. Entt√§usche ihn nicht..."
            ],

            shouldTrigger(night) {
                // Trigger alle 7-10 N√§chte + 15% Zufallschance
                const isScheduled = night === 7 || night === 14 || night === 21 ||
                                   night === 30 || night === 40 || night === 50 ||
                                   night === 60 || night === 70 || night === 80 || night === 90;
                const randomTrigger = Math.random() < 0.15;

                return isScheduled || (night > 10 && randomTrigger);
            },

            getRandomCharacter() {
                return this.characters[Math.floor(Math.random() * this.characters.length)];
            },

            getRandomStory() {
                return this.stories[Math.floor(Math.random() * this.stories.length)];
            },

            activate() {
                document.getElementById('gameScreen').classList.add('danger-mode');
                document.getElementById('npcAvatar').classList.add('danger-avatar');
                AudioSystem.playDangerSound();
            },

            deactivate() {
                document.getElementById('gameScreen').classList.remove('danger-mode');
                document.getElementById('npcAvatar').classList.remove('danger-avatar');
            }
        };

        // ==================== PDF EXPORT ====================
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Titel
            doc.setFontSize(24);
            doc.setTextColor(106, 27, 154);
            doc.text('Brookhaven Mathe Abenteuer', 105, 20, { align: 'center' });

            // Spieler Info
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text(`Spieler: ${gameState.playerName}`, 20, 40);
            doc.text(`Datum: ${new Date().toLocaleDateString('de-DE')}`, 20, 50);

            // Statistiken
            doc.setFontSize(16);
            doc.setTextColor(255, 107, 107);
            doc.text('Ergebnisse', 20, 70);

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Erreichte Nacht: ${gameState.currentNight} von 99`, 20, 85);
            doc.text(`Gesammelte Bloxy Coins: ${gameState.coins}`, 20, 95);
            doc.text(`H√∂chste Serie: ${gameState.maxStreak}`, 20, 105);
            doc.text(`Benutzte Tipps: ${gameState.hintsUsed}`, 20, 115);

            const correctCount = gameState.sessionProblems.filter(p => p.correct).length;
            const totalCount = gameState.sessionProblems.length;
            const percentage = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;
            doc.text(`Richtige Antworten: ${correctCount} von ${totalCount} (${percentage}%)`, 20, 125);

            // Score
            const score = HighScoreSystem.calculateScore(gameState);
            doc.setFontSize(14);
            doc.setTextColor(255, 215, 0);
            doc.text(`Endpunktzahl: ${score}`, 20, 140);

            // Aufgaben-Tabelle
            if (gameState.sessionProblems.length > 0) {
                doc.setFontSize(16);
                doc.setTextColor(106, 27, 154);
                doc.text('Aufgaben-√úbersicht', 20, 160);

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);

                let y = 175;
                doc.text('Nacht', 20, y);
                doc.text('Aufgabe', 45, y);
                doc.text('Deine Antwort', 110, y);
                doc.text('Richtig', 160, y);

                y += 5;
                doc.line(20, y, 190, y);
                y += 10;

                const maxProblems = Math.min(gameState.sessionProblems.length, 20);
                for (let i = 0; i < maxProblems; i++) {
                    const p = gameState.sessionProblems[i];
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.text(String(p.night), 20, y);
                    doc.text(p.question.substring(0, 25), 45, y);
                    doc.text(String(p.userAnswer), 110, y);
                    doc.setTextColor(p.correct ? 0 : 255, p.correct ? 150 : 0, 0);
                    doc.text(p.correct ? 'Ja' : 'Nein', 160, y);
                    doc.setTextColor(0, 0, 0);
                    y += 10;
                }

                if (gameState.sessionProblems.length > 20) {
                    doc.text(`... und ${gameState.sessionProblems.length - 20} weitere Aufgaben`, 20, y + 10);
                }
            }

            // Pet
            doc.setFontSize(12);
            const petY = Math.min(y + 30, 280);
            doc.text(`Ziel-Pet: ${gameState.targetPetName}`, 20, petY);

            doc.save(`Brookhaven_Mathe_${gameState.playerName}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // ==================== GAME STATE ====================
        let gameState = {
            playerName: '',
            targetPet: 'unicorn',
            targetPetName: 'Einhorn',
            targetPetEmoji: 'ü¶Ñ',
            currentNight: 1,
            coins: 0,
            streak: 0,
            maxStreak: 0,
            currentProblem: null,
            hintsUsed: 0,
            sessionProblems: [],
            isDangerMode: false,
            dangerSurvived: 0
        };

        // Roblox-Charaktere f√ºr die Geschichte
        const characters = [
            { name: 'Professor Pixel', emoji: 'üë®‚Äçüî¨', style: 'freundlich' },
            { name: 'Noob', emoji: 'üòä', style: 'lustig' },
            { name: 'Builderman', emoji: 'üë∑', style: 'ermutigend' },
            { name: 'Bacon Hair', emoji: 'üßë‚Äçü¶∞', style: 'freundlich' },
            { name: 'Guest', emoji: 'üë§', style: 'geheimnisvoll' },
            { name: 'Korblox', emoji: 'ü¶¥', style: 'cool' },
            { name: 'Dominus', emoji: 'üëë', style: 'k√∂niglich' }
        ];

        // Geschichten f√ºr verschiedene N√§chte
        const stories = [
            "Du betrittst Brookhaven und triffst auf mich! Um das erste Tor zu √∂ffnen, l√∂se diese Aufgabe:",
            "Ein mysteri√∂ser Nebel zieht auf. Nur die richtige Zahl kann ihn vertreiben!",
            "Du findest eine verschlossene Schatzkiste. Der Code ist eine Mathe-Aufgabe!",
            "Ein freundlicher Noob braucht deine Hilfe! Kannst du ihm bei dieser Rechnung helfen?",
            "Du entdeckst ein geheimes Haus. Die T√ºr √∂ffnet sich nur mit der richtigen Antwort!",
            "Oh nein! Ein Hindernis blockiert den Weg. Berechne die L√∂sung, um weiterzukommen!",
            "Du triffst einen anderen Spieler. Er fordert dich zu einem Mathe-Duell heraus!",
            "Eine magische Br√ºcke erscheint, aber sie ist noch unvollst√§ndig. Welche Zahl fehlt?",
            "Du findest einen Roboter, der einen Fehler hat. Repariere ihn mit Mathe!",
            "Fast geschafft! Noch eine Aufgabe, dann bist du sicher f√ºr diese Nacht!"
        ];

        // Aufgaben nach Schwierigkeitsgrad
        const problemGenerators = {
            easy: [
                () => {
                    const a = Math.floor(Math.random() * 10) + 1;
                    const b = Math.floor(Math.random() * 10) + 1;
                    return { question: `${a} + ${b} = ?`, answer: a + b, hint: `Z√§hle ${a} und dann noch ${b} dazu!` };
                },
                () => {
                    const a = Math.floor(Math.random() * 10) + 5;
                    const b = Math.floor(Math.random() * 5) + 1;
                    return { question: `${a} - ${b} = ?`, answer: a - b, hint: `Du hast ${a} und nimmst ${b} weg.` };
                },
                () => {
                    const answer = Math.floor(Math.random() * 10) + 1;
                    const b = Math.floor(Math.random() * 10) + 1;
                    return { question: `? + ${b} = ${answer + b}`, answer: answer, hint: `Was plus ${b} ergibt ${answer + b}?` };
                }
            ],
            medium: [
                () => {
                    const start = Math.floor(Math.random() * 5) * 10 + 10;
                    const step = [5, 10][Math.floor(Math.random() * 2)];
                    const pos = Math.floor(Math.random() * 3) + 1;
                    let sequence = [];
                    for (let i = 0; i < 5; i++) {
                        sequence.push(start + i * step);
                    }
                    const answer = sequence[pos];
                    sequence[pos] = '?';
                    return { question: sequence.join(', '), answer: answer, hint: `Die Zahlen werden immer um ${step} gr√∂√üer!` };
                },
                () => {
                    const a = Math.floor(Math.random() * 5) + 2;
                    const b = Math.floor(Math.random() * 5) + 2;
                    return { question: `${a} √ó ${b} = ?`, answer: a * b, hint: `${a} mal ${b} bedeutet: ${a} + `.repeat(b-1) + a };
                },
                () => {
                    const a = Math.floor(Math.random() * 30) + 20;
                    const b = Math.floor(Math.random() * 15) + 5;
                    return { question: `${a} - ${b} = ?`, answer: a - b, hint: `Rechne erst ${a} - ${Math.floor(b/10)*10}, dann noch -${b % 10}` };
                }
            ],
            hard: [
                () => {
                    const b = [2, 3, 4, 5][Math.floor(Math.random() * 4)];
                    const answer = Math.floor(Math.random() * 8) + 2;
                    const a = answer * b;
                    return { question: `${a} : ${b} = ?`, answer: answer, hint: `Wie oft passt ${b} in ${a}?` };
                },
                () => {
                    const num = Math.floor(Math.random() * 30) + 10;
                    return { question: `Das Doppelte von ${num} = ?`, answer: num * 2, hint: `Doppelt bedeutet: ${num} + ${num}` };
                },
                () => {
                    const num = (Math.floor(Math.random() * 25) + 5) * 2;
                    return { question: `Die H√§lfte von ${num} = ?`, answer: num / 2, hint: `Teile ${num} in zwei gleiche Teile!` };
                }
            ],
            expert: [
                () => {
                    const divisor = [3, 4, 5, 6, 7][Math.floor(Math.random() * 5)];
                    const quotient = Math.floor(Math.random() * 8) + 2;
                    const remainder = Math.floor(Math.random() * (divisor - 1)) + 1;
                    const dividend = quotient * divisor + remainder;
                    return {
                        question: `${dividend} : ${divisor} = ? Rest ${remainder}`,
                        answer: quotient,
                        hint: `${quotient} √ó ${divisor} = ${quotient * divisor}, und ${quotient * divisor} + ${remainder} = ${dividend}`
                    };
                },
                () => {
                    const answer = Math.floor(Math.random() * 30) + 10;
                    const b = Math.floor(Math.random() * 20) + 10;
                    const sum = answer + b;
                    return { question: `${sum} - ? = ${b}`, answer: answer, hint: `Was musst du von ${sum} abziehen, um ${b} zu bekommen?` };
                },
                () => {
                    const a = Math.floor(Math.random() * 8) + 3;
                    const b = Math.floor(Math.random() * 8) + 3;
                    return { question: `${a} √ó ${b} = ?`, answer: a * b, hint: `Denk an die ${a}er-Reihe!` };
                }
            ]
        };

        // Pet-Auswahl
        document.querySelectorAll('.pet-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.pet-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                gameState.targetPet = option.dataset.pet;
                gameState.targetPetName = option.dataset.name;
                gameState.targetPetEmoji = option.querySelector('.emoji').textContent;
            });
        });

        function showPetSelection() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                document.getElementById('playerName').style.border = '3px solid #ff6b6b';
                return;
            }
            gameState.playerName = name;
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('petScreen').classList.remove('hidden');

            // Initialize audio on user interaction
            AudioSystem.init();
        }

        function startGame() {
            if (!gameState.targetPet) {
                alert('Bitte w√§hle ein Pet aus!');
                return;
            }
            document.getElementById('petScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('header').classList.remove('hidden');
            document.getElementById('helpBtn').classList.remove('hidden');
            document.getElementById('highscoreBtn').classList.remove('hidden');
            document.getElementById('targetPetName').textContent = gameState.targetPetName;

            // Initialize systems
            ConfettiSystem.init();

            generateProblem();
        }

        function generateProblem() {
            const night = gameState.currentNight;
            let difficulty;

            if (night <= 15) difficulty = 'easy';
            else if (night <= 35) difficulty = 'medium';
            else if (night <= 60) difficulty = 'hard';
            else difficulty = 'expert';

            const generators = problemGenerators[difficulty];
            const generator = generators[Math.floor(Math.random() * generators.length)];
            gameState.currentProblem = generator();

            // Update UI
            document.getElementById('currentNight').textContent = night;
            document.getElementById('night').textContent = night;
            document.getElementById('mathProblem').textContent = gameState.currentProblem.question;

            // Check for danger mode
            if (DangerSystem.shouldTrigger(night)) {
                gameState.isDangerMode = true;
                DangerSystem.activate();

                const dangerChar = DangerSystem.getRandomCharacter();
                const dangerStory = DangerSystem.getRandomStory();

                document.getElementById('npcAvatar').textContent = dangerChar.emoji;
                document.getElementById('storyText').innerHTML = `<strong>${dangerChar.name}:</strong> ${dangerStory}`;
            } else {
                gameState.isDangerMode = false;
                DangerSystem.deactivate();

                // Zuf√§lliger Charakter und Geschichte
                const character = characters[Math.floor(Math.random() * characters.length)];
                const story = stories[Math.floor(Math.random() * stories.length)];

                document.getElementById('npcAvatar').textContent = character.emoji;
                document.getElementById('storyText').innerHTML = `<strong>${character.name}:</strong> ${story}`;
            }

            // Reset
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').focus();
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('hintBox').classList.add('hidden');

            updateProgress();
        }

        function checkEnter(event) {
            if (event.key === 'Enter') {
                checkAnswer();
            }
        }

        function checkAnswer() {
            const userAnswer = parseInt(document.getElementById('answerInput').value);
            const correctAnswer = gameState.currentProblem.answer;
            const feedback = document.getElementById('feedback');
            const feedbackText = document.getElementById('feedbackText');
            const rewardText = document.getElementById('rewardText');

            if (isNaN(userAnswer)) {
                document.getElementById('answerInput').style.border = '3px solid #ff6b6b';
                return;
            }

            // Track the problem
            gameState.sessionProblems.push({
                night: gameState.currentNight,
                question: gameState.currentProblem.question,
                correctAnswer: correctAnswer,
                userAnswer: userAnswer,
                correct: userAnswer === correctAnswer
            });

            feedback.classList.remove('hidden', 'correct', 'wrong');

            if (userAnswer === correctAnswer) {
                // Richtige Antwort
                feedback.classList.add('correct');
                gameState.streak++;
                if (gameState.streak > gameState.maxStreak) {
                    gameState.maxStreak = gameState.streak;
                }

                const baseCoins = 10;
                const streakBonus = gameState.streak > 1 ? gameState.streak * 2 : 0;
                const dangerBonus = gameState.isDangerMode ? 25 : 0;
                const coinsEarned = baseCoins + streakBonus + dangerBonus;
                gameState.coins += coinsEarned;

                if (gameState.isDangerMode) {
                    gameState.dangerSurvived++;
                }

                // Sound & Visual feedback
                AudioSystem.playCorrectSound();
                ConfettiSystem.launch();
                RewardSystem.celebrateCorrectAnswer();

                if (gameState.streak >= 3) {
                    RewardSystem.celebrateStreak(gameState.streak);
                }

                const successMessages = [
                    `Super gemacht, ${gameState.playerName}! üéâ`,
                    `Perfekt! Du bist ein Mathe-Profi! ‚≠ê`,
                    `Richtig! Du rockst das! üöÄ`,
                    `Genial! Weiter so! üí™`,
                    `Wow, das war schnell! üåü`,
                    `Fantastisch! ${gameState.targetPetEmoji} ist stolz auf dich!`
                ];

                let rewardMessage = `+${coinsEarned} Bloxy Coins! üí∞`;
                if (gameState.streak > 1) rewardMessage += ` (${gameState.streak}er Serie!)`;
                if (dangerBonus > 0) rewardMessage += ` (+${dangerBonus} Gefahren-Bonus!)`;

                feedbackText.textContent = successMessages[Math.floor(Math.random() * successMessages.length)];
                rewardText.textContent = rewardMessage;

                document.getElementById('coins').textContent = gameState.coins;
                document.getElementById('streak').textContent = gameState.streak;

                // N√§chste Nacht nach kurzer Pause
                setTimeout(() => {
                    gameState.currentNight++;
                    if (gameState.currentNight > 99) {
                        showVictory();
                    } else {
                        generateProblem();
                    }
                }, 2000);
            } else {
                // Falsche Antwort
                feedback.classList.add('wrong');
                gameState.streak = 0;
                document.getElementById('streak').textContent = 0;

                AudioSystem.playWrongSound();

                const encouragements = [
                    `Fast! Die richtige Antwort ist ${correctAnswer}. Versuch's nochmal!`,
                    `Nicht ganz, aber du schaffst das! Es war ${correctAnswer}.`,
                    `√úbung macht den Meister! Die L√∂sung war ${correctAnswer}.`,
                    `Kopf hoch! ${correctAnswer} war richtig. Weiter geht's!`
                ];

                feedbackText.textContent = encouragements[Math.floor(Math.random() * encouragements.length)];
                rewardText.textContent = 'Keine Sorge, du bekommst eine neue Chance! üí™';

                // Neue Aufgabe nach kurzer Pause (gleiche Nacht)
                setTimeout(() => {
                    generateProblem();
                }, 2500);
            }

            saveGame();
        }

        function showHint() {
            const hintBox = document.getElementById('hintBox');
            document.getElementById('hintText').textContent = gameState.currentProblem.hint;
            hintBox.classList.remove('hidden');
            gameState.hintsUsed++;
        }

        function updateProgress() {
            const progress = Math.round((gameState.currentNight / 99) * 100);
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = progress;
        }

        function showVictory() {
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('header').classList.add('hidden');
            document.getElementById('helpBtn').classList.add('hidden');
            document.getElementById('highscoreBtn').classList.add('hidden');
            document.getElementById('rewardScreen').classList.remove('hidden');

            // Victory fanfare
            AudioSystem.playVictoryFanfare();
            ConfettiSystem.launch();

            // Calculate and save high score
            const score = HighScoreSystem.calculateScore(gameState);
            const placement = HighScoreSystem.saveHighScore(
                gameState.playerName,
                score,
                gameState.currentNight,
                gameState.coins
            );

            // Show placement badge
            const placementBadge = document.getElementById('placementBadge');
            if (placement && placement <= 10) {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const medal = placement <= 3 ? medals[placement - 1] : 'üèÖ';
                placementBadge.textContent = `${medal} Platz ${placement} in den High Scores!`;
                placementBadge.classList.remove('hidden');
            }

            document.getElementById('bigRewardEmoji').textContent = gameState.targetPetEmoji;
            document.getElementById('rewardMessage').innerHTML = `
                <p>Herzlichen Gl√ºckwunsch, ${gameState.playerName}!</p>
                <p>Du hast alle 99 N√§chte √ºberlebt und dein ${gameState.targetPetName} ${gameState.targetPetEmoji} verdient!</p>
                <p>Gesammelte Bloxy Coins: ${gameState.coins} üí∞</p>
                <p>Endpunktzahl: ${score} Punkte</p>
                <p>H√∂chste Serie: ${gameState.maxStreak} üî•</p>
                ${gameState.dangerSurvived > 0 ? `<p>√úberstandene Bedrohungen: ${gameState.dangerSurvived} üëπ</p>` : ''}
            `;
        }

        function showHighScores() {
            const scores = HighScoreSystem.getHighScores();
            const tbody = document.getElementById('highscoreTableBody');
            tbody.innerHTML = '';

            if (scores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Noch keine High Scores!</td></tr>';
            } else {
                scores.forEach((score, index) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const medal = index < 3 ? `<span class="medal">${medals[index]}</span>` : (index + 1);

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${medal}</td>
                        <td>${score.name}</td>
                        <td>${score.score}</td>
                        <td>${score.night}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            document.getElementById('highscoreModal').classList.remove('hidden');
        }

        function closeHighScores() {
            document.getElementById('highscoreModal').classList.add('hidden');
        }

        function closeModalOutside(event) {
            if (event.target.id === 'highscoreModal') {
                closeHighScores();
            }
        }

        function resetGame() {
            gameState = {
                playerName: '',
                targetPet: 'unicorn',
                targetPetName: 'Einhorn',
                targetPetEmoji: 'ü¶Ñ',
                currentNight: 1,
                coins: 0,
                streak: 0,
                maxStreak: 0,
                currentProblem: null,
                hintsUsed: 0,
                sessionProblems: [],
                isDangerMode: false,
                dangerSurvived: 0
            };

            document.querySelectorAll('.pet-option').forEach(o => o.classList.remove('selected'));
            document.getElementById('rewardScreen').classList.add('hidden');
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('placementBadge').classList.add('hidden');
            document.getElementById('playerName').value = '';
            document.getElementById('coins').textContent = '0';
            document.getElementById('streak').textContent = '0';

            DangerSystem.deactivate();
            ConfettiSystem.stop();
        }

        // Speichern im Local Storage
        function saveGame() {
            localStorage.setItem('brookhavenMathGame', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('brookhavenMathGame');
            if (saved) {
                gameState = JSON.parse(saved);
            }
        }
    </script>
</body>
</html>
